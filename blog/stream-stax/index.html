<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.0"/><meta data-react-helmet="true" name="description" content="On one hand, Java developers love to work with streams of data using the `java.util.stream` package, because it is easy to apply transformations, filtering, and aggregation. On the other hand, the Streaming API for XML (StAX) makes reading XML streamwise easy, but there are no easy ways to filter, transform, and aggregate the data. How can a Java developer connect these two APIs to use the best of both?
"/><meta data-react-helmet="true" property="og:title" content="☕️ Connecting Java&#x27;s Streaming API for XML (StAX) with Streams"/><meta data-react-helmet="true" property="og:description" content="On one hand, Java developers love to work with streams of data using the `java.util.stream` package, because it is easy to apply transformations, filtering, and aggregation. On the other hand, the Streaming API for XML (StAX) makes reading XML streamwise easy, but there are no easy ways to filter, transform, and aggregate the data. How can a Java developer connect these two APIs to use the best of both?
"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="jdgilday"/><meta data-react-helmet="true" name="twitter:title" content="☕️ Connecting Java&#x27;s Streaming API for XML (StAX) with Streams"/><meta data-react-helmet="true" name="twitter:description" content="On one hand, Java developers love to work with streams of data using the `java.util.stream` package, because it is easy to apply transformations, filtering, and aggregation. On the other hand, the Streaming API for XML (StAX) makes reading XML streamwise easy, but there are no easy ways to filter, transform, and aggregate the data. How can a Java developer connect these two APIs to use the best of both?
"/><style data-href="/styles.365cb0e06c679154ef07.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#073642}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><title data-react-helmet="true">☕️ Connecting Java&#x27;s Streaming API for XML (StAX) with Streams | Johnathan Gilday</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42.72rem;padding:2.67rem 1.335rem"><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.78 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:300;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:2.2974rem;line-height:2.67rem;letter-spacing:-2px;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}ul{margin-left:1.78rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.78rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;font-size:0.85rem;line-height:1.78rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;font-size:1rem;line-height:1.78rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}blockquote{margin-left:0;margin-right:1.78rem;margin-top:0;padding-bottom:0;padding-left:1.44625rem;padding-right:0;padding-top:0;margin-bottom:1.78rem;font-size:1.1487rem;line-height:1.78rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.33375rem solid hsla(0,0%,0%,0.2);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.78rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.78rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.78rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.78rem;margin-bottom:calc(1.78rem / 2);margin-top:calc(1.78rem / 2);}li > ul{margin-left:1.78rem;margin-bottom:calc(1.78rem / 2);margin-top:calc(1.78rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.78rem / 2);}code{font-size:0.85rem;line-height:1.78rem;}kbd{font-size:0.85rem;line-height:1.78rem;}samp{font-size:0.85rem;line-height:1.78rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.18667rem;padding-right:1.18667rem;padding-top:0.89rem;padding-bottom:calc(0.89rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#f92300;text-decoration:none;}a:hover,a:active{text-decoration:underline;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.78rem;color:hsla(0,0%,0%,0.9);font-weight:300;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.78rem;}blockquote{margin-left:-1.335rem;margin-right:0;padding-left:1.00125rem;}}@media only screen and (max-width:768px){h1{font-size:2rem;line-height:2.67rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.56rem;}a.gatsby-resp-image-link{box-shadow:none;}</style><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a href="/blog/">/ gilday / blog</a></h3></header><main><article><header><h1 style="margin-top:1.78rem;margin-bottom:0">☕️ Connecting Java&#x27;s Streaming API for XML (StAX) with Streams</h1><p style="font-size:0.87055rem;line-height:1.78rem;display:block;margin-bottom:1.78rem">December 15, 2022</p></header><section><p>I recently had to process large XML documents in Java, so I reached for Java’s
Streaming API for XML (StAX). The document had a long list of relatively small
elements. Java’s new switch expressions made parsing the XML with StAX much
nicer than I remembered; however, I found myself missing the filtering,
transformation, and aggregation methods from <code class="language-text">java.util.stream.Stream</code>.</p>
<p>I wanted to use StAX to parse the XML elements into a Java record, and I wanted
to use a <code class="language-text">Stream</code> to process those records. In this blog post, I detail how to
do that efficiently.</p>
<h2>Parsing All the Sandwiches</h2>
<p>Consider an arbitrarily large XML document containing a list of favorite
sandwiches. Of course, we could parse all the favorite sandwiches into a
<code class="language-text">java.util.Collection</code> then call <code class="language-text">stream()</code>. However, we know this is not
efficient, because it requires the JVM to hold all the data from the large XML
document in memory.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token comment">// 🤢 Inefficient, because it reads all the records into memory before processing</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span></span> sandwiches <span class="token operator">=</span> <span class="token function">parseAllSandwiches</span><span class="token punctuation">(</span><span class="token string">"./sandwiches.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Stream</span> sandwichesStream <span class="token operator">=</span> sandwiches<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Instead, we want a <code class="language-text">Stream</code> that parses the XML data as-needed. To build such a
stream, we define a new type that implements <code class="language-text">java.util.stream.Spliterator</code>
interface. A <code class="language-text">Spliterator</code> is the <code class="language-text">java.util.stream</code> equivalent of a cursor, and
it facilitates making new <code class="language-text">Stream</code> instances from data that can be iterated on
and optionally partitioned. In this example, the XML data is given to the
<code class="language-text">Spliterator</code> as an <code class="language-text">InputStream</code>, so it cannot be partitioned.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">FavoriteSandwichXMLSpliterator</span>
    <span class="token keyword">implements</span> <span class="token class-name">Spliterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">XMLEventReader</span> reader<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">FavoriteSandwichXMLSpliterator</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      reader <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createXMLEventReader</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XMLStreamException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Failed to parse favorite sandwiches from XML"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div>
<p>The <code class="language-text">Spliterator</code> parses the XML as-needed in its <code class="language-text">tryAdvance</code> method.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">XMLEvent</span> event<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      event <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">nextEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XMLStreamException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedXMLStreamException</span><span class="token punctuation">(</span><span class="token string">"Failed to read favorite sandwiches from XML"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isStartElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> <span class="token class-name">StartElement</span> startElement <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">asStartElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>startElement<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"favorite-sandwich"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">FavoriteSandwich</span> sandwich<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          sandwich <span class="token operator">=</span> <span class="token function">readSandwich</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// implementation omitted for brevity</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XMLStreamException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedXMLStreamException</span><span class="token punctuation">(</span><span class="token string">"Failed to read favorite sandwich from XML"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>sandwich<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The remaining methods of the <code class="language-text">Spliterator</code> interface return values that
communicate to the <code class="language-text">Stream</code> that we do not know how long the <code class="language-text">Stream</code> is and it
cannot be partitioned. Finally, all this is encapsulated in a factory method
that returns a new <code class="language-text">Stream</code>.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span></span> <span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token keyword">var</span> spliterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FavoriteSandwichXMLSpliterator</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">StreamSupport</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This factory method provides the <code class="language-text">Stream&lt;FavoriteSandwich></code> that developers want
to use while encapsulating the XML parsing that developers do not want to think
about. For example, it’s now incredibly simple to compute a count of favorite
sandwiches by the U.S. state they’re from:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">stream_all_valid_sandwiches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">FavoriteSandwichXMLParser</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FavoriteSandwichXMLParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> is <span class="token operator">=</span>
      <span class="token class-name">FavoriteSandwichXMLParserTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"/favorite-sandwiches.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sandwiches <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> countByState <span class="token operator">=</span>
        sandwiches<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
            <span class="token function">groupingBy</span><span class="token punctuation">(</span>sandwich <span class="token operator">-></span> sandwich<span class="token punctuation">.</span><span class="token function">restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">counting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> expected <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"NJ"</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">,</span> <span class="token string">"MD"</span><span class="token punctuation">,</span> <span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>countByState<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsExactlyInAnyOrderEntriesOf</span><span class="token punctuation">(</span>expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Perfect! 🥪</p>
<h2>Resource Management Special Case</h2>
<p>In the previous example, the <code class="language-text">Stream&lt;FavoriteSandwich></code> data was processed
entirely within a try-with-resources statement that ensures the <code class="language-text">InputStream</code>
will be closed. While this is ideal, it may not always be possible to manage the
IO resources this way. For example, consider the case where some existing method
expects a <code class="language-text">Supplier&lt;Stream&lt;FavoriteSandwich>></code>. In this case, the <code class="language-text">Supplier</code>
cannot use try-with-resources, because it cannot know when to close the
<code class="language-text">InputStream</code>.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token comment">// 🐛 Will close the InputStream before any code can operate on the Stream</span>
<span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stream</span><span class="token punctuation">&lt;</span><span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span><span class="token punctuation">></span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> is <span class="token operator">=</span>
      <span class="token class-name">FavoriteSandwichXMLParserTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"/favorite-sandwiches.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedIOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Instead, we want to clean-up the resources when the <code class="language-text">Stream</code> has been closed.
Fortunately, <code class="language-text">Stream</code> implements <code class="language-text">AutoCloseable</code>, and the
<a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/stream/Stream.html">Stream Javadoc</a>
instructs users to close streams that are backed by an IO channel.</p>
<blockquote>
<p>Streams have a BaseStream.close() method and implement AutoCloseable, but
nearly all stream instances do not actually need to be closed after use.
Generally, only streams whose source is an IO channel (such as those returned
by Files.lines(Path, Charset)) will require closing. Most streams are backed
by collections, arrays, or generating functions, which require no special
resource management. (If a stream does require closing, it can be declared as
a resource in a try-with-resources statement.)</p>
</blockquote>
<p>We can take advantage of this to handle this special case where the <code class="language-text">Stream</code>
must clean-up the IO channel it encapsulates.</p>
<p>First, we make the <code class="language-text">FavoriteSandwichXMLSpliterator</code> implement <code class="language-text">AutoCloseable</code>.
The <code class="language-text">close()</code> method simply closes the <code class="language-text">InputStream</code> passed to the constructor
and propagates any exceptions as a <code class="language-text">RuntimeException</code>.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XMLStreamException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedXMLStreamException</span><span class="token punctuation">(</span><span class="token string">"Failed to close XMLEventReader"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In this case, we define a new runtime exception <code class="language-text">UncheckedXMLStreamException</code>
that is the StAX analog to <code class="language-text">UncheckedIOException</code>.</p>
<p>Lastly, we change the factory that creates the <code class="language-text">Stream</code>, so that the <code class="language-text">Stream</code>
closes the <code class="language-text">Spliterator</code> when it has been closed. This is made possible by the
<code class="language-text">Stream.onClose(Runnable)</code> method that allows users to schedule arbitrary
routines to be executed when the <code class="language-text">Stream</code> is closed.</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span></span> <span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token keyword">var</span> spliterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FavoriteSandwichXMLSpliterator</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token class-name">StreamSupport</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span>spliterator<span class="token operator">::</span><span class="token function">close</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Having made these changes, the <code class="language-text">Stream</code> itself may be in a try-with-resources to
ensure that the IO is closed properly:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stream</span><span class="token punctuation">&lt;</span><span class="token class-name">FavoriteSandwich</span><span class="token punctuation">></span><span class="token punctuation">></span></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">var</span> sandwiches <span class="token operator">=</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sandwiches<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Conclusion</h2>
<p>Arbitrarily large streams of data, such as a large XML document, are ripe for
processing with the <code class="language-text">java.util.stream</code> APIs, but developers need way to parse
records from the stream as-needed and expose those elements as a <code class="language-text">Stream</code>. The
<code class="language-text">Spliterator</code> interface is the key that unlocks the power of the <code class="language-text">Stream</code> API
for data that may be processed stream-wise. Additionally, when the <code class="language-text">Stream</code> must
also clean-up the underlying IO resources after it has been exhausted, the
<code class="language-text">Stream.onClose(Runnable)</code> method is available to schedule that clean-up.</p>
<p>The accompanying code may be found at
<a href="https://github.com/gilday/how-to-stream-stax">gilday/how-to-stream-stax</a>.</p></section><hr style="margin-bottom:1.78rem"/><footer><div style="display:flex;margin-bottom:4.45rem"><div data-gatsby-image-wrapper="" style="position:relative;overflow:hidden;width:50px;height:50px;margin-right:0.89rem;margin-bottom:0;min-width:50px;border-radius:100%" class="gatsby-image-wrapper"><div aria-hidden="true" data-placeholder-image="" style="height:100%;left:0;position:absolute;top:0;width:100%"></div><picture><source type="image/webp" data-srcset="/static/22d7c60e65a56e5da11fd167da768779/dbc4a/profile-pic.webp 50w,/static/22d7c60e65a56e5da11fd167da768779/d8057/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" data-main-image="" style="height:100%;left:0;position:absolute;top:0;transform:translateZ(0);transition:opacity 250ms linear;width:100%;will-change:opacity;border-radius:50%;opacity:0" sizes="50px" decoding="async" loading="lazy" data-src="/static/22d7c60e65a56e5da11fd167da768779/6ac16/profile-pic.jpg" data-srcset="/static/22d7c60e65a56e5da11fd167da768779/6ac16/profile-pic.jpg 50w,/static/22d7c60e65a56e5da11fd167da768779/e07e1/profile-pic.jpg 100w" alt="Johnathan Gilday"/></picture><noscript><picture><source type="image/webp" srcSet="/static/22d7c60e65a56e5da11fd167da768779/dbc4a/profile-pic.webp 50w,/static/22d7c60e65a56e5da11fd167da768779/d8057/profile-pic.webp 100w" sizes="50px"/><img data-gatsby-image-ssr="" data-main-image="" style="height:100%;left:0;position:absolute;top:0;transform:translateZ(0);transition:opacity 250ms linear;width:100%;will-change:opacity;border-radius:50%;opacity:0" sizes="50px" decoding="async" loading="lazy" src="/static/22d7c60e65a56e5da11fd167da768779/6ac16/profile-pic.jpg" srcSet="/static/22d7c60e65a56e5da11fd167da768779/6ac16/profile-pic.jpg 50w,/static/22d7c60e65a56e5da11fd167da768779/e07e1/profile-pic.jpg 100w" alt="Johnathan Gilday"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div><p>Written by<!-- --> <strong><a href="/">Johnathan Gilday</a></strong>. <!-- -->Red Bank, NJ, USA based software developer.</p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/blog/maven-toolchain-tests/">← <!-- -->🦉 Testing Across JDKs with Maven Toolchains</a></li><li></li></ul></nav></main><footer>© <!-- -->2023<!-- -->, <!-- -->Johnathan Gilday<!-- --> </footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-28952450-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/stream-stax/";window.___webpackCompilationHash="c7fcde301fbe8e42b5d9";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-4744e713a07aff3c090c.js"],"app":["/app-0eb4ea386f065e956c37.js"],"component---src-pages-404-js":["/component---src-pages-404-js-91bf0cf4896c362a0c1b.js"],"component---src-pages-blog-tsx":["/component---src-pages-blog-tsx-3c44b2864810aeab8026.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-1b9eda5bd57f0b7474f0.js"],"component---src-pages-resume-tsx":["/component---src-pages-resume-tsx-ea467d964f27ce3a5822.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-d12c7454a2e62e74be9b.js"]};/*]]>*/</script><script src="/polyfill-4744e713a07aff3c090c.js" nomodule=""></script><script src="/app-0eb4ea386f065e956c37.js" async=""></script><script src="/framework-101016b0692be428e7a1.js" async=""></script><script src="/webpack-runtime-338ca642621566673572.js" async=""></script></body></html>